<%- include layouts/vip_header.ejs %>
<section id="header">
    <div class="container">
        <form action="/vip/check" method="post">
            <input type="text" class="invis" name="idvisita" id="ids">
        </form>
        <div class='banner text-center'>
            <h1 class="section-title wow bounceInDown animated"><span>Tiempos</span></h1>
            <div class="col-sm-12 col-md-12">
                <div class="panel panel-warning">
                    <div class="panel-heading">
                        Ãšltimos 5 minutos
                    </div>
                    <table class="table table-responsive">
                        <thead>
                        <tr class="warning">
                            <th></th>
                            <th>Nombre</th>
                            <th>Apellido</th>
                            <th>Tiempo Restante</th>
                        </tr>
                        </thead>
                        <tbody>

                        <%
                        if(ends.length){
                        for(var i = 0;i < ends.length; i++){
                            if(i%2) {
                                var activ = "";
                            } else {
                                var activ = " traslucid"
                            }
                            if(ends[i].ended == 1){
                        %>
                        <tr class="warning<%= activ%>">
                            <td></td>
                            <td><%= ends[i].name%></td>
                            <td><%= ends[i].last_name%></td>
                            <td><div id="<%= ends[i].id%>" class="text-warning"></div></td>
                        </tr>
                        <script type="text/javascript">
                            setInterval(function () {
                                var target_date = new Date('<%= ends[i].date_f %>').getTime();
                                // find the amount of "seconds" between now and target
                                var current_date = new Date().getTime();
                                var seconds_left = (target_date - current_date) / 1000;
                                var countdown = document.getElementById('<%= ends[i].id %>');
                                if (seconds_left <= 0){
                                    window.location.href = "/vip/end/<%= ends[i].id %>"
                                }
                                // do some time calculations
                                minutes = parseInt(seconds_left / 60);
                                seconds = parseInt(seconds_left % 60);
                                countdown.innerHTML = '<span class="minutes">'
                                    + minutes + ' <b>Min</b></span> <span class="seconds">' + seconds + ' <b>s</b></span>';
                            },1000);
                        </script>
                        <% } else {%>
                        <tr class="danger<%= activ%>">
                            <td><%= ends[i].id%></td>
                            <td><%= ends[i].name%></td>
                            <td><%= ends[i].last_name%></td>
                            <td><div class="text-danger">Tiempo Cumplido</div></td>
                        </tr>
                        <form id="<%= ends[i].id%>" method="post" action="/vip/check">
                            <input type="hidden" name="idvisita" value="<%= ends[i].id%>" />
                            </form>
                        <script type="text/javascript">
                            setInterval(function () {
                                var target_date = new Date('<%= ends[i].date_f %>').getTime();
                                // find the amount of "seconds" between now and target
                                var current_date = new Date().getTime();
                                var seconds_left = (target_date - current_date) / 1000;
                                if(seconds_left <= -5*60) {
                                    var form = document.getElementById('<%= ends[i].id %>');
                                    form.submit();
                                }
                            },1000);
                        </script>
                        <%
                                }
                            }
                        } else{%>
                        <tr><td>-</td><td>-</td><td>-</td></tr>
                        <%
                        }
                        %>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="col-sm-12 col-md-12 ">
                <div class="panel panel-info">
                    <div class="panel-heading">
                        En Curso
                    </div>
                    <table class="table table-responsive">
                        <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Apellido</th>
                            <th>Tiempo Restante</th>
                        </tr>
                        </thead>
                        <tbody>

                        <%
                        if(data.length){

                            for(var k = 0;k < data.length; k++){
                            if(k%2) {
                                var activ = "";
                            } else {
                                var activ = " traslucid"
                            }
                        %>
                            <tr class="<%= activ%>">
                                <td><%= data[k].name%></td>
                                <td><%= data[k].last_name%></td>
                                <td><div id="<%= data[k].id%>"></div></td>
                            </tr>
                            <script type="text/javascript">
                                var hours, minutes, seconds;
                                setInterval(function () {
                                    var target_date = new Date('<%= data[k].date_f %>').getTime();
                                    // get tag element
                                    var countdown = document.getElementById('<%= data[k].id %>');
                                    // find the amount of "seconds" between now and target
                                    var current_date = new Date().getTime();
                                    var seconds_left = (target_date - current_date) / 1000;
                                    if (seconds_left <= 5 * 60) {
                                        window.location.href = "/vip/near/<%= data[k].id %>"
                                    }


                                    hours = parseInt(seconds_left / 3600);
                                    seconds_left = seconds_left % 3600;

                                    minutes = parseInt(seconds_left / 60);
                                    seconds = parseInt(seconds_left % 60);

                                    if (hours > 0) {
                                        // format countdown string + set tag value
                                        countdown.innerHTML = '<span class="hours">' + hours + ' <b>Hrs</b></span> <span class="minutes">'
                                            + minutes + ' <b>Min</b></span> <span class="seconds">' + seconds + ' <b>s</b></span>';
                                    } else {
                                        countdown.innerHTML = '<span class="minutes">'
                                            + minutes + ' <b>Min</b></span> <span class="seconds">' + seconds + ' <b>s</b></span>';

                                    }
                                },1000);
                            </script>

                            <%
                            }
                        } else{%>
                            <tr><td>No hay Jumpers</td><td>-</td><td>-</td><td>-</td><td>-</td></tr>
                        <% } %>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

</section>



        
<%- include layouts/vip_footer.ejs %>